{% extends "accounts/base.html" %}
{% block content %}
<style>
.card {
  border-radius: 16px !important;
}
input, select {
  border-radius: 8px !important;
}
.table th, .table td {
  vertical-align: middle;
}
.table-hover tbody tr:hover {
  background-color: #f8f9fa;
}
.btn-acciones {
  min-width: 85px;
}
</style>
<div class="row">
  <!-- Formulario Usuario -->
  <div class="col-md-4">
    <div class="card mb-4 shadow-sm border-0">
      <div class="card-body">
        <h5 class="card-title mb-3 fw-bold">
          {% if edit_mode %}Editar usuario{% else %}Nuevo usuario{% endif %}
        </h5>
        <form method="post" autocomplete="off">
          {% csrf_token %}
          {% if edit_mode %}
            <input type="hidden" name="edit_id" value="{{ edit_id }}">
          {% endif %}
          <div class="mb-3">
            <label class="form-label">Username <span class="text-muted small">(requerido, único)</span></label>
            <input type="text" class="form-control" name="username" value="{{ form.username.value|default_if_none:'' }}" required />
          </div>
          <div class="mb-3">
            <label class="form-label">Email <span class="text-muted small">(requerido, único)</span></label>
            <input type="email" class="form-control" name="email" value="{{ form.email.value|default_if_none:'' }}" required />
          </div>
          <div class="row">
            <div class="col">
              <label class="form-label">Nombres <span class="text-muted small">(requerido)</span></label>
              <input type="text" class="form-control" name="nombre" value="{{ form.nombre.value|default_if_none:'' }}" required />
            </div>
            <div class="col">
              <label class="form-label">Apellidos <span class="text-muted small">(requerido)</span></label>
              <input type="text" class="form-control" name="apellido" value="{{ form.apellido.value|default_if_none:'' }}" required />
            </div>
          </div>
          <div class="mb-3 mt-2">
            <label class="form-label">Rol</label>
            <select class="form-select" name="rol" required>
              {% for value, text in form.rol.field.choices %}
                <option value="{{ value }}"{% if form.rol.value == value %} selected{% endif %}>{{ text }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Estado</label>
            <select class="form-select" name="estado" required>
              {% for value, text in form.estado.field.choices %}
                <option value="{{ value }}"{% if form.estado.value == value %} selected{% endif %}>{{ text }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">MFA habilitado</label>
            <select class="form-select" name="mfa_habilitado" required>
              {% for value, text in form.mfa_habilitado.field.choices %}
                <option value="{{ value }}"{% if form.mfa_habilitado.value == value %} selected{% endif %}>{{ text }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="d-flex justify-content-end mt-4">
            <button type="submit" class="btn btn-primary me-2">
              {% if edit_mode %}Actualizar{% else %}Guardar{% endif %}
            </button>
            {% if edit_mode %}
              <a href="{% url 'Formulario' %}" class="btn btn-outline-secondary">Cancelar</a>
            {% else %}
              <button type="reset" class="btn btn-outline-secondary">Limpiar</button>
            {% endif %}
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Tabla de usuarios -->
  <div class="col-md-8">
    <div class="card shadow-sm border-0">
      <div class="card-body">
        <h5 class="card-title mb-3 fw-bold">Usuarios</h5>
        <div class="d-flex flex-wrap mb-3 gap-2">
          <input type="text" class="form-control me-2 mb-2" placeholder="Buscar por username" style="max-width:200px;">
          <select class="form-select me-2 mb-2" style="max-width:130px;">
            <option>Rol: todos</option>
            <option>ADMIN</option>
            <option>AUDITOR</option>
            <option>OPERADOR</option>
          </select>
          <select class="form-select me-2 mb-2" style="max-width:130px;">
            <option>Estado: todos</option>
            <option>ACTIVO</option>
            <option>INACTIVO</option>
            <option>BLOQUEADO</option>
          </select>
          <button class="btn btn-outline-primary ms-auto mb-2">
            <i class="bi bi-file-earmark-excel"></i> Exportar a Excel
          </button>
        </div>
        <div class="table-responsive">
          <table class="table align-middle table-hover table-bordered rounded">
            <thead class="table-light">
              <tr class="align-middle text-center">
                <th>Username</th>
                <th>Email</th>
                <th>Nombre</th>
                <th>Apellido</th>
                <th>Rol</th>
                <th>Estado</th>
                <th>MFA</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              {% for usuario in usuarios %}
              <tr>
                <td>{{ usuario.username }}</td>
                <td>{{ usuario.email }}</td>
                <td>{{ usuario.nombre }}</td>
                <td>{{ usuario.apellido }}</td>
                <td>{{ usuario.get_rol_display }}</td>
                <td>
                  <span class="badge {% if usuario.estado == 'activo' %}bg-success{% else %}bg-danger{% endif %}">
                    {{ usuario.get_estado_display }}
                  </span>
                </td>
                <td>
                  <span class="badge {% if usuario.mfa_habilitado == 'habilitado' %}bg-primary{% else %}bg-secondary{% endif %}">
                    {{ usuario.get_mfa_habilitado_display }}
                  </span>
                </td>
                <td class="text-center btn-acciones">
                  <a href="?edit_id={{ usuario.pk }}" class="btn btn-sm btn-outline-secondary mb-1" title="Editar">
                    <i class="bi bi-pencil-square"></i>
                  </a>
                  <a href="?delete_id={{ usuario.pk }}" class="btn btn-sm btn-outline-danger mb-1" title="Eliminar"
                     onclick="return confirm('¿Seguro que deseas eliminar este usuario?')">
                    <i class="bi bi-trash"></i>
                  </a>
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="8" class="text-center text-muted">Sin usuarios registrados.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
